#!/usr/bin/env python
import argparse
import os
import sys
import logging

import signal
signal.signal(signal.SIGPIPE, signal.SIG_DFL)
signal.signal(signal.SIGINT, signal.SIG_DFL)

parser = argparse.ArgumentParser(description='''
  Concatenate and print files.
''')
parser.add_argument(
    'files', metavar='N', nargs='*', help='Pathname to input files.')
parser.add_argument(
    '-u',
    dest='buffering',
    action='store_const',
    const=0,
    default=-1,
    help='unbuffer output')
parser.add_argument(
    '-v', dest='log_level', action='count', default=0, help='verbose output')

args = parser.parse_intermixed_args()

files = args.files
if len(files) == 0:
    files.append('-')

output = os.fdopen(sys.stdout.fileno(), 'wb', args.buffering)

logging.basicConfig(
    level=os.environ.get('LOG_LEVEL', logging.WARN - args.log_level * 10),
    format='[%(asctime)s] %(levelname)s %(filename)s - %(message)s',
    datefmt='%Y-%m-%dT%H:%M:%S%z',
)
logger = logging.getLogger(__file__)


#############################################################################
def copy_stream(i, o, chuck_size=1024):
    while True:
        data = i.read(chuck_size)
        logger.debug(f"read: {len(data)}")
        if len(data) == 0:
            break
        o.write(data)


#############################################################################

for filename in files:
    logger.info(f"filename: {filename}")

    # If a file is '-', the cat utility shall read from the standard input at
    # that point in the sequence. The cat utility shall not close and reopen
    # standard input when it is referenced in this way, but shall accept
    # multiple occurrences of '-' as a file operand.
    if filename == '-':
        copy_stream(sys.stdin.buffer, output, 1)
        continue

    with open(filename, 'rb') as f:
        copy_stream(f, output, 1)
